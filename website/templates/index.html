{% extends "base.html" %}
{% block title %}Chat ¬∑ AI Assistant{% endblock %}

{% block head %}
<style>
  .chat-wrapper {
    height: 70vh;
    overflow-y: auto;
    padding: 20px;
    border-radius: 1rem;
    background: rgba(15,23,42,0.45);
    transition: background 0.3s ease, color 0.3s ease;
  }

  .chat-message {
    display: flex;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
  }

  .chat-message.user {
    justify-content: flex-end;
  }

  .chat-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 0.9rem;
    line-height: 1.4rem;
  }

  .chat-bubble.user {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #ffffff;
    border-bottom-right-radius: 4px;
    margin-left: 10px;
    box-shadow: 0 8px 20px rgba(79,70,229,0.35);
  }

  .chat-bubble.bot {
    background: rgba(30, 41, 59, 0.88);
    border: 1px solid rgba(148,163,184,0.25);
    color: #e2e8f0;
    border-bottom-left-radius: 4px;
    margin-right: 10px;
  }

  .chat-wrapper.light .chat-bubble.bot {
    background: #ffffff;
    border-color: #e5e7eb;
    color: #111827;
  }

  .avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
  }

  .avatar.user {
    background-image: url('https://i.ibb.co/RDXd5JN/user.png');
  }

  .avatar.bot {
    background-image: url('https://i.ibb.co/xzJQWxM/ai.png');
  }

  .timestamp {
    font-size: 11px;
    opacity: 0.55;
    margin-top: 3px;
  }

  .theme-toggle {
    cursor: pointer;
    font-size: 20px;
    margin-left: 0.75rem;
  }

  /* Light mode overrides for chat */
  body.light-mode .chat-wrapper {
    background: #f3f4f6;
    color: #111827;
    border: 1px solid #e5e7eb;
  }

  body.light-mode .chat-bubble.bot {
    background: #ffffff;
    border-color: #e5e7eb;
    color: #111827;
  }

  body.light-mode .chat-bubble.user {
    background: linear-gradient(135deg, #2563eb, #4f46e5);
  }

  body.light-mode .timestamp {
    color: #6b7280;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}

{% block content %}

<div class="container" style="max-width: 900px;">
  <!-- Header -->
  <div class="d-flex align-items-center mb-3">
    <div>
      <h4 class="mb-0">AI Healthcare Assistant</h4>
      <div class="text-muted-xs">Ask clinical, wellness, or general health questions.</div>
    </div>
    <span id="themeToggle" class="theme-toggle ms-auto">üåô</span>
  </div>

  <!-- Chat area -->
  <div id="chat-wrapper" class="chat-wrapper">
    {% if history %}
      {% for msg in history %}
        {% if msg.sender == 'bot' %}
          <div class="chat-message bot">
            <div class="avatar bot me-2"></div>
            <div>
          <div class="chat-bubble bot">{{ msg.text | safe }}</div>
              <div class="timestamp">{{ msg.time }}</div>
            </div>
          </div>
        {% else %}
          <div class="chat-message user">
            <div>
              <div class="chat-bubble user">{{ msg.text }}</div>
              <div class="timestamp text-end">{{ msg.time }}</div>
            </div>
            <div class="avatar user ms-2"></div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="text-muted-xs text-center mt-4">
        Start the conversation by asking your first question üëá
      </div>
    {% endif %}
  </div>

  <!-- Input -->
  <form id="chat-form" class="d-flex mt-3">
    <input
      id="text"
      type="text"
      name="msg"
      class="form-control me-2"
      placeholder="Type your question..."
      autocomplete="off"
      required
    />
    <button type="submit" class="btn btn-primary-soft">Send</button>
  </form>
</div>

{% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
  const wrapper = document.getElementById("chat-wrapper");

  function scrollToBottom() {
    wrapper.scrollTop = wrapper.scrollHeight;
  }

  // Typing animation for bot messages
  function typeAnimation(element, text, speed = 18) {
    let i = 0;
    function typing() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        setTimeout(typing, speed);
      }
    }
    typing();
  }

  $("#chat-form").on("submit", function (e) {
    e.preventDefault();

    const rawText = $("#text").val().trim();
    if (!rawText) return;

    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Append user message
    $("#chat-wrapper").append(`
      <div class="chat-message user">
        <div>
          <div class="chat-bubble user">${rawText}</div>
          <div class="timestamp text-end">${timestamp}</div>
        </div>
        <div class="avatar user ms-2"></div>
      </div>
    `);

    $("#text").val("");
    scrollToBottom();

    $.post("/get", { msg: rawText }, function (data) {
      const botBlock = $(`
        <div class="chat-message bot">
          <div class="avatar bot me-2"></div>
          <div>
            <div class="chat-bubble bot"></div>
            <div class="timestamp">${timestamp}</div>
          </div>
        </div>
      `);

      $("#chat-wrapper").append(botBlock);
      const bubble = botBlock.find(".chat-bubble")[0];

      bubble.innerHTML = data;
      scrollToBottom();
    }).fail(function () {
      const botError = `
        <div class="chat-message bot">
          <div class="avatar bot me-2"></div>
          <div>
            <div class="chat-bubble bot">Sorry, something went wrong. Please try again.</div>
            <div class="timestamp">${timestamp}</div>
          </div>
        </div>
      `;
      $("#chat-wrapper").append(botError);
      scrollToBottom();
    });
  });

  scrollToBottom();

  // Dark / Light mode toggle
  const toggle = document.getElementById("themeToggle");
  const bodyEl = document.body;
  let dark = true;

  toggle.addEventListener("click", () => {
    dark = !dark;
    if (dark) {
      wrapper.classList.remove("light");
      bodyEl.classList.remove("light-mode");
      toggle.textContent = "üåô";
    } else {
      wrapper.classList.add("light");
      bodyEl.classList.add("light-mode");
      toggle.textContent = "‚òÄÔ∏è";
    }
  });
</script>
{% endblock %}
